---
const { lang, t } = Astro.props;

const projects =
  lang === "es"
    ? (await import("../data/projects/es.json")).default
    : (await import("../data/projects/en.json")).default;
---
<section id="projects">
  <h2>{t.projects.title}</h2>

  <ul class="projects-list">
    {projects.map((project, index) => (
      <li class="project-card" data-index={index}>
        <!-- VIDEO WITH LOADING BAR -->
        <div class="project-media">
          <video
            class="project-video"
            muted
            loop
            playsinline
            preload="metadata"
            poster={project.thumbnail ?? "/gifs/default-thumb.webp"}
            data-src={project.video}
          ></video>

          <!-- Progress bar overlay -->
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
        </div>

        <!-- CONTENT -->
        <div class="project-content">
          <h3>{project.title}</h3>
          <p>{project.description}</p>

          <p class="project-tech">
            <strong>Tech:</strong> {project.tech.join(", ")}
          </p>

          <p class="project-result">
            <strong>Result:</strong> {project.result}
          </p>

          <div class="project-links">
            <a href={project.demo}>Demo</a>
          </div>
        </div>
      </li>
    ))}
  </ul>
</section>

<style>
.project-media {
  position: relative;
  width: 340px;
  height: 190px;
  border-radius: 12px;
  overflow: hidden;
  background: var(--chip);
}

.project-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  pointer-events: none;
}

/* Loading bar overlay */
.progress-bar {
  position: absolute;
  bottom: 6px; /* un poco separada del borde */
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 24px);
  height: 6px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 999px;
  overflow: hidden;
  pointer-events: none;
  backdrop-filter: blur(4px);
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: var(--border);
  border-radius: inherit;
  transition: width 0.12s linear;
}
</style>

<script>
function initProjectVideos() {
  const cards = document.querySelectorAll(".project-media");
  const isMobile = window.matchMedia("(hover: none)").matches;

  let activeVideo = null;

  cards.forEach((card) => {
    const video = card.querySelector("video");
    const progress = card.querySelector(".progress-fill");
    if (!video || !progress) return;

    let timer;
    let progressValue = 0;

    const delay = 1000; // ms to fill bar
    const intervalTime = 20;
    const increment = (intervalTime / delay) * 100;

    const stopActiveVideo = () => {
      if (activeVideo && activeVideo !== video) {
        activeVideo.pause();
        activeVideo.currentTime = 0;

        const activeProgress =
          activeVideo.closest(".project-card")?.querySelector(".progress-fill");
        if (activeProgress) activeProgress.style.width = "0%";
      }
    };

    const startProgress = () => {
      stopActiveVideo();

      if (!video.src) video.src = video.dataset.src;
      video.load();

      activeVideo = video;
      progressValue = 0;
      progress.style.width = "0%";

      timer = setInterval(() => {
        progressValue += increment;

        if (progressValue >= 100) {
          progressValue = 100;
          clearInterval(timer);

          video.currentTime = 0;
          video.play().catch(() => {});
        }

        progress.style.width = progressValue + "%";
      }, intervalTime);
    };

    const resetDesktop = () => {
      if (isMobile) return;

      clearInterval(timer);
      progress.style.width = "0%";
      video.pause();
      video.currentTime = 0;
      activeVideo = null;
    };

    /* Desktop */
    card.addEventListener("mouseenter", startProgress);
    card.addEventListener("mouseleave", resetDesktop);

    /* Mobile */
    card.addEventListener("touchstart", (e) => {
      e.preventDefault();
      startProgress();
    });
  });
}

document.addEventListener("astro:page-load", initProjectVideos);
document.addEventListener("DOMContentLoaded", initProjectVideos);
</script>

